{% extends 'base.html' %}
{% load static %}
{% load price_filters %}

{% block title %}Order #{{ order.order_number }} - Kaloriz{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/order-detail.css' %}">
{% endblock %}

{% block content %}
<div class="order-detail-page">
  <div class="container-fluid p-3 p-md-4 p-lg-5">
    
    <!-- Back Button -->
    <a href="{% url 'core:order_history' %}" class="order-back-link">
      <i class="fas fa-arrow-left"></i>
      <span>Kembali ke Riwayat</span>
    </a>

    <!-- Order Header -->
    <div class="order-detail-header">
      <div class="order-title">
        <h2>Order #{{ order.order_number }}</h2>
        <p>{{ order.created_at|date:"d F Y, H:i" }}</p>
      </div>
      <div class="order-status-wrapper">
        <small>Status:</small>
        <span class="order-status-badge status-{{ order.status|lower }}">
          {{ order.get_status_display }}
        </span>
      </div>
    </div>

    <!-- Summary Cards -->
    <div class="order-summary-grid">
      <div class="order-summary-card">
        <div class="order-summary-icon">
          <i class="fas fa-calendar-alt"></i>
        </div>
        <div class="order-summary-content">
          <div class="order-summary-label">Tanggal Order</div>
          <div class="order-summary-value">{{ order.created_at|date:"d M Y" }}</div>
        </div>
      </div>

      <div class="order-summary-card">
        <div class="order-summary-icon">
          <i class="fas fa-box"></i>
        </div>
        <div class="order-summary-content">
          <div class="order-summary-label">Total Item</div>
          <div class="order-summary-value">{{ order_items|length }} Produk</div>
        </div>
      </div>

      <div class="order-summary-card">
        <div class="order-summary-icon">
          <i class="fas fa-truck"></i>
        </div>
        <div class="order-summary-content">
          <div class="order-summary-label">Metode Pengiriman</div>
          <div class="order-summary-value">{{ shipping_method_display }}</div>
        </div>
      </div>

      <div class="order-summary-card">
        <div class="order-summary-icon">
          <i class="fas fa-money-bill-wave"></i>
        </div>
        <div class="order-summary-content">
          <div class="order-summary-label">Total Pembayaran</div>
          <div class="order-summary-value">Rp {{ order.total|dot_separator }}</div>
        </div>
      </div>
    </div>

    <!-- Main Content Grid -->
    <div class="order-main-grid">
      <div class="order-content-grid">
        
        <!-- Order Items Table/Cards -->
        <div class="order-items-table-wrapper">
          <h4 class="mb-4">Detail Pesanan</h4>
          
          <!-- Desktop Table -->
          <table class="order-items-table d-none d-md-table">
            <thead>
              <tr>
                <th>Produk</th>
                <th>Harga</th>
                <th>Jumlah</th>
                <th>Subtotal</th>
              </tr>
            </thead>
            <tbody>
              {% for item in order_items %}
              <tr>
                <td>
                  <strong>{{ item.display_name }}</strong>
                  {% if item.display_category %}
                  <br>
                  <small class="text-muted">{{ item.display_category }}</small>
                  {% endif %}
                </td>
                <td>Rp {{ item.display_price|dot_separator }}</td>
                <td>{{ item.quantity }}x</td>
                <td>Rp {{ item.display_subtotal|dot_separator }}</td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="4" class="text-center text-muted">Tidak ada item pada pesanan ini.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>

          <!-- Mobile Cards (visible on small screens) -->
          <div class="d-md-none">
            {% for item in order_items %}
            <div class="order-item-card">
              <div class="order-item-card-header">
                <div>
                  <div class="order-item-label">Produk</div>
                  <strong>{{ item.display_name }}</strong>
                  {% if item.display_category %}
                  <br>
                  <small class="text-muted">{{ item.display_category }}</small>
                  {% endif %}
                </div>
                <div class="text-right">
                  <div class="order-item-label">Subtotal</div>
                  <div class="order-item-price">Rp {{ item.display_subtotal|dot_separator }}</div>
                </div>
              </div>
              <div class="order-item-card-body">
                <div class="order-item-info">
                  <span>Harga Satuan</span>
                  <span>Rp {{ item.display_price|dot_separator }}</span>
                </div>
                <div class="order-item-info">
                  <span>Jumlah</span>
                  <span>{{ item.quantity }}x</span>
                </div>
              </div>
            </div>
            {% empty %}
            <p class="text-center text-muted">Tidak ada item pada pesanan ini.</p>
            {% endfor %}
          </div>

          <!-- Total Summary -->
          <div class="order-total-summary">
            <div class="order-total-row">
              <span>Subtotal</span>
              <span>Rp {{ order.subtotal|dot_separator }}</span>
            </div>
            {% if order.discount_amount %}
            <div class="order-total-row">
              <span>Diskon</span>
              <span class="text-success">-Rp {{ order.discount_amount|dot_separator }}</span>
            </div>
            {% endif %}
            <div class="order-total-row">
              <span>Ongkir</span>
              <span>Rp {{ order.shipping_cost|dot_separator }}</span>
            </div>
            {% if order.tax_amount %}
            <div class="order-total-row">
              <span>Pajak</span>
              <span>Rp {{ order.tax_amount|dot_separator }}</span>
            </div>
            {% endif %}
            <div class="order-total-row grand-total">
              <span>Total</span>
              <span>Rp {{ order.total|dot_separator }}</span>
            </div>
          </div>
        </div>

        <!-- Order Info Panel -->
        <div class="order-info-panel">
          <!-- Customer Information -->
          <div class="order-info-card">
            <div class="order-info-panel-header">
              <h5><i class="fas fa-user mr-2"></i>Informasi Pelanggan</h5>
            </div>
            <table class="order-info-table">
              <tr>
                <th>Nama</th>
                <td>{{ order.user.get_full_name|default:order.user.username }}</td>
              </tr>
              <tr>
                <th>Email</th>
                <td>{{ order.user.email }}</td>
              </tr>
              <tr>
                <th>No. HP</th>
                <td>{{ order.phone|default:"-" }}</td>
              </tr>
            </table>
          </div>

          <!-- Shipping Address -->
          <div class="order-address-card mt-3">
            <div class="card-header">
              <i class="fas fa-map-marker-alt mr-2"></i>Alamat Pengiriman
            </div>
            <div class="card-body">
              {% if order.shipping_address %}
              <p class="mb-1">{{ order.shipping_address.street_address }}</p>
              {% if order.shipping_address.apartment_address %}
              <p class="mb-1">{{ order.shipping_address.apartment_address }}</p>
              {% endif %}
              <p class="mb-1">
                {{ order.shipping_address.city }}, 
                {{ order.shipping_address.province }}
              </p>
              <p class="mb-0">{{ order.shipping_address.postal_code }}</p>
              {% else %}
              <p class="text-muted mb-0">Alamat tidak tersedia</p>
              {% endif %}
            </div>
          </div>

          <!-- Payment Information -->
          <div class="order-info-card mt-3">
            <div class="order-info-panel-header">
              <h5><i class="fas fa-credit-card mr-2"></i>Informasi Pembayaran</h5>
            </div>
            <table class="order-info-table">
              <tr>
                <th>Metode</th>
                <td>
                  <span class="badge badge-info">
                    {{ order.payment_method|default:"Transfer Bank" }}
                  </span>
                </td>
              </tr>
              <tr>
                <th>Status</th>
                <td>
                  {% if order.payment_status == 'paid' %}
                    <span class="badge badge-success">Lunas</span>
                  {% elif order.payment_status == 'pending' %}
                    <span class="badge badge-warning">Menunggu</span>
                  {% else %}
                    <span class="badge badge-danger">Belum Bayar</span>
                  {% endif %}
                </td>
              </tr>
            </table>
          </div>

          <!-- Action Buttons -->
          {% if order.status == 'pending' or order.status == 'processing' %}
          <div class="order-action-buttons">
            {% if order.payment_status != 'paid' %}
            <a href="{% url 'core:payment' order.id %}" class="btn-order-action btn-primary">
              <i class="fas fa-credit-card"></i>
              Bayar Sekarang
            </a>
            {% endif %}
            <a href="{% url 'core:order_track' order.order_number %}" class="btn-order-action btn-secondary">
              <i class="fas fa-truck"></i>
              Lacak Pesanan
            </a>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Loading State (if needed) -->
<div class="order-loading d-none">
  <div class="order-loading-spinner"></div>
</div>

<!-- Error State (if needed) -->
<div class="order-error d-none">
  <h3>Oops! Ada Kesalahan</h3>
  <p>Tidak dapat memuat detail pesanan. Silakan coba lagi.</p>
</div>

<!-- Empty State (if needed) -->
<div class="order-empty d-none">
  <div class="order-empty-icon">
    <i class="fas fa-inbox"></i>
  </div>
  <h3>Pesanan Tidak Ditemukan</h3>
  <p>Pesanan yang Anda cari tidak dapat ditemukan.</p>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Add data-label attributes for mobile view
  const tableRows = document.querySelectorAll('.order-items-table tbody tr');
  tableRows.forEach(row => {
    const cells = row.querySelectorAll('td');
    if (cells.length >= 4) {
      cells[0].setAttribute('data-label', 'Produk');
      cells[1].setAttribute('data-label', 'Harga');
      cells[2].setAttribute('data-label', 'Jumlah');
      cells[3].setAttribute('data-label', 'Subtotal');
    }
  });

  // Smooth scroll to section when clicking summary cards
  const summaryCards = document.querySelectorAll('.order-summary-card');
  summaryCards.forEach(card => {
    card.style.cursor = 'pointer';
    card.addEventListener('click', function() {
      const itemsSection = document.querySelector('.order-items-table-wrapper');
      if (itemsSection) {
        itemsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    });
  });

  // Print function
  const printButton = document.getElementById('printOrder');
  if (printButton) {
    printButton.addEventListener('click', function(e) {
      e.preventDefault();
      window.print();
    });
  }

  // Handle responsive table on resize
  let resizeTimer;
  window.addEventListener('resize', function() {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(function() {
      // Update table display based on window width
      const windowWidth = window.innerWidth;
      const table = document.querySelector('.order-items-table');
      const mobileCards = document.querySelector('.order-items-mobile');
      
      if (windowWidth >= 768) {
        if (table) table.classList.remove('d-none');
        if (mobileCards) mobileCards.classList.add('d-none');
      } else {
        if (table) table.classList.add('d-none');
        if (mobileCards) mobileCards.classList.remove('d-none');
      }
    }, 250);
  });

  // Add animation when elements come into view
  const observerOptions = {
    threshold: 0.1,
    rootMargin: '0px 0px -50px 0px'
  };

  const observer = new IntersectionObserver(function(entries) {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        entry.target.style.opacity = '1';
        entry.target.style.transform = 'translateY(0)';
      }
    });
  }, observerOptions);

  // Observe elements for animation
  const animatedElements = document.querySelectorAll('.order-summary-card, .order-item-card');
  animatedElements.forEach(el => {
    el.style.opacity = '0';
    el.style.transform = 'translateY(20px)';
    el.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
    observer.observe(el);
  });
});
</script>
{% endblock %}