{% extends 'base.html' %}

{% block title %}Checkout - Kaloriz{% endblock %}

{% block content %}
<div class="container my-5">
  <h2 class="mb-4"><i class="fas fa-credit-card"></i> Checkout</h2>

  {% if not default_address or not default_address.destination_subdistrict_id %}
  <div class="alert alert-warning">
    <i class="fas fa-exclamation-triangle"></i>
    <strong>Alamat Pengiriman Belum Lengkap!</strong>
    <p class="mb-2">Anda perlu menambahkan atau melengkapi alamat pengiriman dengan ID kecamatan RajaOngkir terlebih dahulu.</p>
    <a href="{% url 'core:profile_address_edit' %}" class="btn btn-sm btn-primary">
      <i class="fas fa-edit"></i> Kelola Alamat
    </a>
  </div>
  {% endif %}

  <div class="row">
    <div class="col-md-8">
      <!-- Shipping Address Display -->
      <div class="card shadow mb-4">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0"><i class="fas fa-map-marker-alt"></i> Alamat Pengiriman</h5>
        </div>
        <div class="card-body">
          {% if default_address %}
            <div class="address-display p-3 mb-3 border rounded bg-light">
              <h6 class="mb-2"><strong>{{ default_address.full_name }}</strong></h6>
              <p class="mb-1"><i class="fas fa-phone"></i> {{ default_address.phone }}</p>
              <p class="mb-1">{{ default_address.address_line }}</p>
              <p class="mb-0">
                {{ default_address.subdistrict_name }}, {{ default_address.city_name }}<br>
                {{ default_address.province_name }} {{ default_address.postal_code }}
              </p>
              {% if default_address.destination_subdistrict_id %}
                <small class="text-muted">ID Kecamatan: {{ default_address.destination_subdistrict_id }}</small>
              {% else %}
                <div class="alert alert-warning mt-2 mb-0 p-2">
                  <small><i class="fas fa-exclamation-circle"></i> Alamat ini belum memiliki ID kecamatan RajaOngkir</small>
                </div>
              {% endif %}
            </div>
            <a href="{% url 'core:profile_address_edit' %}" class="btn btn-sm btn-outline-primary">
              <i class="fas fa-edit"></i> Ubah Alamat
            </a>
          {% else %}
            <div class="alert alert-info">
              <i class="fas fa-info-circle"></i> Anda belum memiliki alamat pengiriman.
              <a href="{% url 'core:profile_address_edit' %}" class="alert-link">Tambah alamat sekarang</a>
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Courier Selection -->
      {% if default_address and default_address.destination_subdistrict_id %}
      <div class="card shadow mb-4">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="fas fa-truck"></i> Pilih Kurir & Layanan</h5>
        </div>
        <div class="card-body">
          <form method="post" action="{% url 'core:place_order' %}" id="checkout-form">
            {% csrf_token %}

            <!-- Courier Selection -->
            <div class="form-group">
              <label for="courier">Pilih Kurir *</label>
              <select class="form-control" id="courier" name="courier" required>
                <option value="">-- Pilih Kurir --</option>
                <option value="jne">JNE</option>
                <option value="jnt">J&T Express</option>
                <option value="sicepat">SiCepat</option>
                <option value="tiki">TIKI</option>
                <option value="pos">POS Indonesia</option>
                <option value="anteraja">AnterAja</option>
              </select>
            </div>

            <!-- Loading Indicator -->
            <div id="loading-services" class="text-center py-3" style="display: none;">
              <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
              <p class="mt-2">Memuat layanan pengiriman...</p>
            </div>

            <!-- Shipping Service Selection -->
            <div class="form-group" id="service-selection-group" style="display: none;">
              <label>Pilih Layanan Pengiriman *</label>
              <div id="service-options" class="mt-2">
                <!-- Will be populated by AJAX -->
              </div>
            </div>

            <!-- Additional Order Info -->
            <div class="form-group">
              <label for="notes">Catatan Pesanan (Opsional)</label>
              <textarea class="form-control" id="notes" name="notes" rows="2"
                        placeholder="Contoh: Tolong kirim pakai bubble wrap tambahan"></textarea>
            </div>

            <!-- Hidden fields -->
            <input type="hidden" name="address_id" value="{{ default_address.id }}">
            <input type="hidden" name="selected_service" id="selected_service">
            <input type="hidden" name="selected_service_name" id="selected_service_name">
            <input type="hidden" name="shipping_cost" id="shipping_cost">

            <button type="submit" class="btn btn-success btn-lg btn-block" id="submit-btn" disabled>
              <i class="fas fa-check-circle"></i> Buat Pesanan
            </button>
          </form>
        </div>
      </div>
      {% endif %}
    </div>

    <!-- Order Summary -->
    <div class="col-md-4">
      <div class="card shadow sticky-top" style="top: 20px;">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0">Ringkasan Pesanan</h5>
        </div>
        <div class="card-body">
          <h6 class="mb-3">Item ({{ cart.get_total_items }})</h6>
          {% for item in cart.items.all %}
          <div class="d-flex justify-content-between mb-2">
            <small>{{ item.product.name }} x{{ item.quantity }}</small>
            <small>Rp {{ item.get_subtotal|floatformat:0 }}</small>
          </div>
          {% endfor %}

          <hr>

          <div class="d-flex justify-content-between mb-2">
            <span>Subtotal</span>
            <span id="subtotal-display">Rp {{ cart.get_total|floatformat:0 }}</span>
          </div>
          <div class="d-flex justify-content-between mb-2">
            <span>Berat Total</span>
            <span class="text-muted">{{ total_weight_gram }} gram</span>
          </div>
          <div class="d-flex justify-content-between mb-2">
            <span>Ongkir</span>
            <span id="shipping-display" class="text-muted">Pilih kurir</span>
          </div>

          <hr>
          <div class="d-flex justify-content-between">
            <strong>Total</strong>
            <strong class="text-success" id="total-display">Rp {{ cart.get_total|floatformat:0 }}</strong>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const courierSelect = document.getElementById('courier');
  const loadingServices = document.getElementById('loading-services');
  const serviceSelectionGroup = document.getElementById('service-selection-group');
  const serviceOptions = document.getElementById('service-options');
  const submitBtn = document.getElementById('submit-btn');

  const selectedServiceInput = document.getElementById('selected_service');
  const selectedServiceNameInput = document.getElementById('selected_service_name');
  const shippingCostInput = document.getElementById('shipping_cost');

  const subtotalDisplay = document.getElementById('subtotal-display');
  const shippingDisplay = document.getElementById('shipping-display');
  const totalDisplay = document.getElementById('total-display');

  const subtotal = {{ cart.get_total }};
  const addressId = {{ default_address.id|default:0 }};
  const weightGram = {{ total_weight_gram }};
  let currentShippingCost = 0;

  // Format currency
  function formatCurrency(amount) {
    return 'Rp ' + Math.round(amount).toLocaleString('id-ID');
  }

  // Update total display
  function updateTotal() {
    const total = subtotal + currentShippingCost;
    totalDisplay.textContent = formatCurrency(total);
  }

  // Fetch shipping services when courier is selected
  courierSelect.addEventListener('change', function() {
    const courier = this.value;

    if (!courier) {
      serviceSelectionGroup.style.display = 'none';
      shippingDisplay.textContent = 'Pilih kurir';
      shippingDisplay.classList.add('text-muted');
      submitBtn.disabled = true;
      currentShippingCost = 0;
      updateTotal();
      return;
    }

    if (!addressId || addressId === 0) {
      alert('Alamat pengiriman belum valid. Silakan lengkapi alamat Anda.');
      return;
    }

    // Show loading
    loadingServices.style.display = 'block';
    serviceSelectionGroup.style.display = 'none';
    submitBtn.disabled = true;

    // Fetch shipping quotes from RajaOngkir API
    const url = `/shipping/api/quote-by-address?address_id=${addressId}&courier=${courier}`;

    fetch(url)
      .then(response => response.json())
      .then(data => {
        loadingServices.style.display = 'none';

        if (data.status && data.status.code === 200) {
          // Clear previous options
          serviceOptions.innerHTML = '';

          const results = data.data.results;
          if (!results || results.length === 0) {
            serviceOptions.innerHTML = '<div class="alert alert-warning">Tidak ada layanan tersedia untuk kurir ini.</div>';
            serviceSelectionGroup.style.display = 'block';
            return;
          }

          // Get costs from first courier result
          const courierResult = results[0];
          const costs = courierResult.costs || [];

          if (costs.length === 0) {
            serviceOptions.innerHTML = '<div class="alert alert-warning">Tidak ada layanan tersedia.</div>';
            serviceSelectionGroup.style.display = 'block';
            return;
          }

          // Add radio buttons for each service (already sorted by backend)
          costs.forEach((service, index) => {
            const cost = service.cost[0];
            const serviceName = service.service;
            const description = service.description;
            const costValue = cost.value;
            const etv = cost.etd || 'N/A';

            const optionDiv = document.createElement('div');
            optionDiv.className = 'service-option p-3 mb-2 border rounded';
            optionDiv.innerHTML = `
              <div class="custom-control custom-radio">
                <input type="radio" id="service_${serviceName}" name="service_radio"
                       class="custom-control-input" value="${serviceName}"
                       data-cost="${costValue}"
                       data-service-name="${courierResult.name} - ${serviceName}"
                       ${index === 0 ? 'checked' : ''}>
                <label class="custom-control-label w-100" for="service_${serviceName}">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <strong>${serviceName}</strong> - ${description}<br>
                      <small class="text-muted">Estimasi: ${etv} hari</small>
                    </div>
                    <div class="text-right">
                      <strong class="text-primary">${formatCurrency(costValue)}</strong>
                    </div>
                  </div>
                </label>
              </div>
            `;
            serviceOptions.appendChild(optionDiv);
          });

          // Show service selection group
          serviceSelectionGroup.style.display = 'block';

          // Auto-select first option
          const firstRadio = serviceOptions.querySelector('input[type="radio"]');
          if (firstRadio) {
            firstRadio.checked = true;
            selectService(firstRadio);
          }

          // Add event listeners to radio buttons
          serviceOptions.querySelectorAll('input[type="radio"]').forEach(radio => {
            radio.addEventListener('change', function() {
              selectService(this);
            });
          });

          // Add click event to entire option div
          serviceOptions.querySelectorAll('.service-option').forEach((div, idx) => {
            div.style.cursor = 'pointer';
            div.addEventListener('click', function(e) {
              if (e.target.type !== 'radio') {
                const radio = this.querySelector('input[type="radio"]');
                radio.checked = true;
                selectService(radio);
              }
            });
          });

        } else {
          const errorMsg = data.status ? data.status.description : 'Error tidak diketahui';
          alert('Gagal memuat tarif pengiriman: ' + errorMsg);
          serviceSelectionGroup.style.display = 'none';
        }
      })
      .catch(error => {
        loadingServices.style.display = 'none';
        console.error('Error:', error);
        alert('Terjadi kesalahan dalam memuat tarif pengiriman.');
      });
  });

  // Select service
  function selectService(radio) {
    const service = radio.value;
    const serviceName = radio.dataset.serviceName;
    const cost = parseFloat(radio.dataset.cost);

    // Update hidden inputs
    selectedServiceInput.value = service;
    selectedServiceNameInput.value = serviceName;
    shippingCostInput.value = cost;

    // Update display
    currentShippingCost = cost;
    shippingDisplay.textContent = formatCurrency(cost);
    shippingDisplay.classList.remove('text-muted');

    updateTotal();

    // Enable submit button
    submitBtn.disabled = false;

    // Highlight selected option
    serviceOptions.querySelectorAll('.service-option').forEach(div => {
      div.style.borderColor = '#e0e0e0';
      div.style.backgroundColor = '#fff';
    });
    radio.closest('.service-option').style.borderColor = '#17a2b8';
    radio.closest('.service-option').style.backgroundColor = '#e7f6f8';
  }

  // Form validation
  document.getElementById('checkout-form').addEventListener('submit', function(e) {
    if (!selectedServiceInput.value) {
      e.preventDefault();
      alert('Silakan pilih layanan pengiriman terlebih dahulu.');
      return false;
    }

    if (!shippingCostInput.value) {
      e.preventDefault();
      alert('Biaya pengiriman belum dihitung.');
      return false;
    }
  });
});
</script>

<style>
.address-display {
  background-color: #f8f9fa;
}

.service-option {
  cursor: pointer;
  transition: all 0.3s;
  border: 2px solid #e0e0e0;
}

.service-option:hover {
  border-color: #17a2b8;
  background-color: #f8f9fa;
}

.service-option input[type="radio"]:checked + label {
  color: #17a2b8;
}

.custom-control-label {
  cursor: pointer;
  width: 100%;
}

.sticky-top {
  position: -webkit-sticky;
  position: sticky;
}
</style>
{% endblock %}
