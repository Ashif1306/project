{% extends 'base.html' %}
{% block title %}Keranjang Belanja - Kaloriz{% endblock %}

{% block content %}
<div class="cart-page container py-5">
  <div class="d-flex align-items-center gap-3 mb-4 cart-page__header">
    <span class="cart-page__icon"><i class="fas fa-shopping-cart"></i></span>
    <div>
      <h2 class="mb-1">Keranjang Belanja</h2>
      <p class="text-muted mb-0">Kelola produk pilihanmu sebelum melanjutkan ke pembayaran.</p>
    </div>
  </div>

  {% if cart.items.all %}
  <div class="cart-grid">
    <!-- ====== DAFTAR PRODUK ====== -->
    <section class="cart-items">
      <div class="cart-items__toolbar">
        <div class="form-check d-flex align-items-center gap-2 mb-0">
          <input class="form-check-input cart-checkbox" type="checkbox" id="check-all"
                 {% if cart.items.filter(is_selected=True).count == cart.items.count %}checked{% endif %}>
          <label class="form-check-label text-muted" for="check-all">Pilih semua produk</label>
        </div>
        <span class="small text-muted">Centang produk yang ingin kamu checkout.</span>
      </div>

      <div class="cart-items__list">
        {% for item in cart.items.all %}
        <article class="cart-item-card {% if item.is_selected %}selected{% endif %}"
                 data-item-id="{{ item.id }}"
                 data-price="{{ item.product.price }}">
          <div class="cart-item-card__check">
            <input type="checkbox" class="item-check cart-checkbox" {% if item.is_selected %}checked{% endif %}>
          </div>

          <div class="cart-item-card__thumbnail">
            {% if item.product.image %}
              <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}">
            {% else %}
              <div class="cart-item-card__thumbnail--placeholder">
                <i class="fas fa-image"></i>
              </div>
            {% endif %}
          </div>

          <div class="cart-item-card__body">
            <div class="cart-item-card__title">
              <div>
                <a href="{% url 'catalog:product_detail' item.product.slug %}" class="stretched-link">{{ item.product.name }}</a>
                <p class="text-muted small mb-0">{{ item.product.category.name }}</p>
              </div>
              <form method="post" action="{% url 'core:remove_from_cart' item.id %}" class="ms-auto">
                {% csrf_token %}
                <button type="submit" class="btn btn-link text-danger p-0" title="Hapus" onclick="return confirm('Hapus item ini?')">
                  <i class="fas fa-trash-alt"></i>
                </button>
              </form>
            </div>

            <div class="cart-item-card__meta">
              <div class="cart-item-card__price">
                <span class="text-muted">Harga</span>
                <strong>Rp {{ item.product.get_display_price|floatformat:0 }}</strong>
              </div>
              <div class="cart-item-card__quantity">
                <span class="text-muted">Jumlah</span>
                <form method="post" action="{% url 'core:update_cart_item' item.id %}" class="qty-form">
                  {% csrf_token %}
                  <div class="qty-control" data-max="{{ item.product.stock|default:1 }}">
                    <button class="qty-btn" type="button" data-action="decrease" aria-label="Kurangi jumlah">
                      <i class="fas fa-minus"></i>
                    </button>
                    <input type="number" name="quantity" class="form-control qty-input"
                           min="1" max="{{ item.product.stock }}" value="{{ item.quantity }}">
                    <button class="qty-btn" type="button" data-action="increase" aria-label="Tambah jumlah">
                      <i class="fas fa-plus"></i>
                    </button>
                  </div>
                  <button type="submit" class="visually-hidden">Simpan</button>
                </form>
              </div>
            </div>

            <div class="cart-item-card__subtotal">
              <span class="text-muted">Subtotal</span>
              <strong class="line-subtotal-text">Rp {{ item.get_subtotal|floatformat:0 }}</strong>
            </div>
          </div>
        </article>
        {% endfor %}
      </div>

      <div class="cart-items__actions">
        <button type="button" id="btn-delete-selected" class="btn btn-outline-danger" disabled>
          <i class="fas fa-trash-alt"></i> Hapus Dipilih
        </button>
        <form method="post" action="{% url 'core:clear_cart' %}" class="d-inline">
          {% csrf_token %}
          <button type="submit" class="btn btn-outline-secondary" onclick="return confirm('Kosongkan keranjang?')">
            <i class="fas fa-trash"></i> Kosongkan Keranjang
          </button>
        </form>
      </div>
    </section>

    <!-- ====== RINGKASAN BELANJA ====== -->
    <aside class="cart-summary">
      <div class="cart-summary__card">
        <h5 class="cart-summary__title">Ringkasan Belanja</h5>
        <div class="cart-summary__row">
          <span>Subtotal (<span id="selected-count">{{ cart.get_selected_items_count }}</span> item dipilih)</span>
          <span id="selected-subtotal">Rp {{ cart.get_selected_total|floatformat:0 }}</span>
        </div>
        <div class="cart-summary__row">
          <span>Ongkir</span>
          <span class="text-muted"><small>Dihitung saat checkout</small></span>
        </div>
        <hr>
        <div class="cart-summary__total">
          <div>
            <span class="text-muted">Total Sementara</span>
            <strong class="cart-summary__grand" id="grand-total">Rp {{ cart.get_selected_total|floatformat:0 }}</strong>
          </div>
        </div>
        <button type="button" id="btn-checkout" class="btn btn-primary btn-lg w-100 shadow-sm"
                {% if not cart.get_selected_items_count %}disabled{% endif %}>
          <i class="fas fa-credit-card"></i> Checkout (<span id="checkout-count">{{ cart.get_selected_items_count }}</span>)
        </button>
        <a href="{% url 'catalog:product_list' %}" class="btn btn-outline-primary w-100 mt-2">
          <i class="fas fa-arrow-left"></i> Lanjut Belanja
        </a>
      </div>
    </aside>
  </div>
  {% else %}
  <div class="text-center py-5">
    <i class="fas fa-shopping-cart fa-5x text-muted mb-3"></i>
    <h4>Keranjang Anda Kosong</h4>
    <p class="text-muted">Mulai belanja sekarang!</p>
    <a href="{% url 'catalog:product_list' %}" class="btn btn-primary">
      <i class="fas fa-shopping-bag"></i> Belanja Sekarang
    </a>
  </div>
  {% endif %}
</div>

<style>
  :root {
    --cart-bg: #f5f7fb;
    --cart-card-bg: #ffffff;
    --cart-border: #e5e9f2;
    --cart-primary: #1d4ed8;
    --cart-primary-soft: rgba(29, 78, 216, 0.12);
  }

  .cart-page {
    background: var(--cart-bg);
    border-radius: 24px;
    padding-inline: min(2rem, 5vw);
  }

  .cart-page__header {
    background: var(--cart-card-bg);
    border-radius: 20px;
    padding: 1.5rem;
    box-shadow: 0 12px 28px rgba(15, 23, 42, 0.08);
  }

  .cart-page__icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 56px;
    height: 56px;
    border-radius: 16px;
    background: var(--cart-primary-soft);
    color: var(--cart-primary);
    font-size: 1.5rem;
  }

  .cart-grid {
    display: grid;
    grid-template-columns: minmax(0, 1.8fr) minmax(280px, 1fr);
    gap: 2rem;
    margin-top: 2rem;
  }

  .cart-items__toolbar {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    background: var(--cart-card-bg);
    padding: 1.25rem 1.5rem;
    border-radius: 16px;
    box-shadow: 0 10px 24px rgba(15, 23, 42, 0.08);
    margin-bottom: 1.5rem;
  }

  .cart-checkbox {
    width: 20px;
    height: 20px;
    cursor: pointer;
  }

  .cart-items__list {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }

  .cart-item-card {
    display: grid;
    grid-template-columns: auto 90px minmax(0, 1fr);
    gap: 1.25rem;
    background: var(--cart-card-bg);
    border-radius: 20px;
    padding: 1.5rem;
    box-shadow: 0 18px 30px rgba(15, 23, 42, 0.08);
    transition: transform 0.2s ease, box-shadow 0.2s ease, border 0.2s ease;
    border: 1px solid transparent;
    position: relative;
  }

  .cart-item-card.selected {
    border-color: rgba(29, 78, 216, 0.35);
    box-shadow: 0 20px 32px rgba(29, 78, 216, 0.15);
  }

  .cart-item-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 22px 36px rgba(15, 23, 42, 0.12);
  }

  .cart-item-card__check {
    display: flex;
    align-items: flex-start;
    padding-top: 0.25rem;
  }

  .cart-item-card__thumbnail img,
  .cart-item-card__thumbnail--placeholder {
    width: 90px;
    height: 90px;
    border-radius: 16px;
    object-fit: cover;
    background: #eef2ff;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #94a3b8;
    font-size: 1.5rem;
  }

  .cart-item-card__body {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .cart-item-card__title {
    display: flex;
    gap: 1rem;
    align-items: flex-start;
    position: relative;
  }

  .cart-item-card__title a {
    font-weight: 600;
    color: #0f172a;
    text-decoration: none;
  }

  .cart-item-card__title a:hover {
    color: var(--cart-primary);
  }

  .cart-item-card__title form .btn {
    font-size: 1.1rem;
  }

  .cart-item-card__meta {
    display: flex;
    flex-wrap: wrap;
    gap: 1.5rem;
  }

  .cart-item-card__price,
  .cart-item-card__quantity,
  .cart-item-card__subtotal {
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
  }

  .cart-item-card__subtotal {
    align-items: flex-start;
  }

  .qty-control {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    background: #f1f5f9;
    border-radius: 999px;
    padding: 0.25rem;
  }

  .qty-btn {
    width: 36px;
    height: 36px;
    border: none;
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: var(--cart-card-bg);
    box-shadow: 0 4px 10px rgba(15, 23, 42, 0.08);
    color: #0f172a;
    transition: background 0.2s ease, color 0.2s ease;
  }

  .qty-btn:hover {
    background: var(--cart-primary);
    color: #ffffff;
  }

  .qty-input {
    width: 64px;
    text-align: center;
    border: none;
    background: transparent;
    font-weight: 600;
    box-shadow: none;
  }

  .qty-input:focus {
    outline: none;
    box-shadow: none;
  }

  .cart-items__actions {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin-top: 1.5rem;
  }

  .cart-summary {
    position: relative;
  }

  .cart-summary__card {
    background: var(--cart-card-bg);
    border-radius: 24px;
    padding: 2rem 1.75rem;
    box-shadow: 0 20px 40px rgba(15, 23, 42, 0.12);
    position: sticky;
    top: 20px;
  }

  .cart-summary__title {
    font-weight: 600;
    margin-bottom: 1.5rem;
  }

  .cart-summary__row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
    color: #475569;
  }

  .cart-summary__total {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
  }

  .cart-summary__grand {
    font-size: 1.5rem;
    color: var(--cart-primary);
  }

  .cart-summary .btn-primary {
    background: var(--cart-primary);
    border: none;
  }

  .cart-summary .btn-primary:hover {
    background: #1e40af;
  }

  @media (max-width: 991.98px) {
    .cart-grid {
      grid-template-columns: 1fr;
    }

    .cart-summary__card {
      position: static;
    }
  }

  @media (max-width: 767.98px) {
    .cart-item-card {
      grid-template-columns: auto minmax(0, 1fr);
    }

    .cart-item-card__thumbnail {
      grid-column: 1 / span 2;
      order: 1;
    }

    .cart-item-card__body {
      grid-column: 1 / span 2;
    }

    .cart-item-card__check {
      order: -1;
    }

    .cart-item-card__meta {
      flex-direction: column;
      gap: 1rem;
    }

    .cart-items__toolbar {
      padding: 1rem 1.25rem;
    }
  }

  @media (max-width: 575.98px) {
    .cart-page {
      padding-inline: 1rem;
    }

    .cart-page__header {
      flex-direction: column;
      align-items: flex-start;
    }

    .cart-items__actions {
      flex-direction: column;
      align-items: stretch;
    }

    .cart-summary__card {
      padding: 1.5rem;
    }

    .qty-control {
      width: 100%;
      justify-content: space-between;
    }

    .qty-input {
      flex: 1;
    }
  }
</style>

<script>
(function(){
  const fmt = new Intl.NumberFormat('id-ID');
  const rp  = n => 'Rp ' + fmt.format(Math.round(n || 0));

  const rows     = () => Array.from(document.querySelectorAll('.cart-item-card'));
  const checkAll = document.getElementById('check-all');
  const elCount  = document.getElementById('selected-count');
  const elSub    = document.getElementById('selected-subtotal');
  const elGrand  = document.getElementById('grand-total');
  const btnCk    = document.getElementById('btn-checkout');
  const elCkCnt  = document.getElementById('checkout-count');
  const btnDel   = document.getElementById('btn-delete-selected');

  function csrf(){
    return getCookie('csrftoken') || '';
  }

  function computeLine(card){
    const price = parseFloat(card.dataset.price) || 0;
    const qtyEl = card.querySelector('.qty-input');
    const qty   = Math.max(1, parseInt(qtyEl.value, 10) || 1);
    const line  = price * qty;
    card.querySelector('.line-subtotal-text').textContent = rp(line);
    return { qty, line };
  }

  function recompute(){
    let cnt = 0, subtotal = 0;
    rows().forEach(card => {
      const { line } = computeLine(card);
      const checked = card.querySelector('.item-check').checked;
      card.classList.toggle('selected', checked);
      if (checked){
        cnt += 1;
        subtotal += line;
      }
    });
    elCount.textContent = cnt;
    elSub.textContent   = rp(subtotal);
    elGrand.textContent = rp(subtotal);
    elCkCnt.textContent = cnt;
    if (btnCk) btnCk.disabled  = cnt === 0;
    if (btnDel) btnDel.disabled = cnt === 0;

    if (checkAll){
      const checks = rows().map(card => card.querySelector('.item-check'));
      const all  = checks.length && checks.every(ch => ch.checked);
      const some = checks.some(ch => ch.checked);
      checkAll.indeterminate = !all && some;
      checkAll.checked = all;
    }
  }

  document.addEventListener('input', e => {
    if (!e.target.classList.contains('qty-input')) return;
    if (+e.target.value < 1) e.target.value = 1;
    recompute();
  });

  document.addEventListener('keydown', e => {
    if (e.target.classList.contains('qty-input') && e.key === 'Enter'){
      e.preventDefault();
      e.target.closest('form')?.submit();
    }
  });

  document.addEventListener('change', e => {
    if (e.target.classList.contains('item-check')){
      const card = e.target.closest('.cart-item-card');
      fetch(`/cart/toggle-select/${card.dataset.itemId}/`, {
        method:'POST',
        headers:{'Content-Type':'application/json','X-CSRFToken':csrf()},
        body:JSON.stringify({is_selected:e.target.checked})
      }).catch(()=>{});
      recompute();
    }

    if (e.target.id === 'check-all'){
      const on = e.target.checked;
      rows().forEach(card => {
        const ch = card.querySelector('.item-check');
        ch.checked = on;
        fetch(`/cart/toggle-select/${card.dataset.itemId}/`, {
          method:'POST',
          headers:{'Content-Type':'application/json','X-CSRFToken':csrf()},
          body:JSON.stringify({is_selected:on})
        }).catch(()=>{});
      });
      recompute();
    }
  });

  document.querySelectorAll('.qty-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const form = btn.closest('form');
      const input = form?.querySelector('.qty-input');
      if (!input) return;
      const min = parseInt(input.min, 10) || 1;
      const max = parseInt(input.max, 10) || Infinity;
      const current = parseInt(input.value, 10) || min;
      const delta = btn.dataset.action === 'increase' ? 1 : -1;
      let next = current + delta;
      if (next < min) next = min;
      if (next > max) next = max;
      if (next === current) return;
      input.value = next;
      recompute();
      if (form?.requestSubmit) form.requestSubmit();
      else form?.submit();
    });
  });

  btnDel?.addEventListener('click', () => {
    const ids = rows().filter(card => card.querySelector('.item-check').checked)
                      .map(card => card.dataset.itemId);
    if (!ids.length) return;
    if (!confirm(`Hapus ${ids.length} item yang dipilih?`)) return;

    fetch('/cart/delete-selected/', {
      method:'POST',
      headers:{'Content-Type':'application/json','X-CSRFToken':csrf()},
      body:JSON.stringify({item_ids: ids})
    }).then(r => r.json()).then(res => {
      if (res.success) location.reload();
      else alert(res.message || 'Gagal menghapus item');
    }).catch(() => alert('Terjadi kesalahan jaringan.'));
  });

  btnCk?.addEventListener('click', () => {
    if (!btnCk.disabled) window.location.href = "{% url 'core:checkout' %}";
  });

  recompute();
})();
</script>

{% endblock %}
