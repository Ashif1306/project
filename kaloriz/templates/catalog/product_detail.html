{% extends 'base.html' %}
{% load price_filters %}

{% block title %}{{ product.name }} - Kaloriz{% endblock %}

{% block content %}
<div class="container my-5">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{% url 'catalog:home' %}">Home</a></li>
      <li class="breadcrumb-item"><a href="{% url 'catalog:product_list' %}">Produk</a></li>
      <li class="breadcrumb-item"><a href="{% url 'catalog:category_detail' product.category.slug %}">{{ product.category.name }}</a></li>
      <li class="breadcrumb-item active">{{ product.name }}</li>
    </ol>
  </nav>

  <div class="row">
    <!-- Product Image -->
    <div class="col-md-5">
      <div class="card shadow">
        {% if product.image %}
          <img src="{{ product.image.url }}" class="card-img-top" alt="{{ product.name }}">
        {% else %}
          <img src="https://via.placeholder.com/500x500?text={{ product.name }}" class="card-img-top" alt="{{ product.name }}">
        {% endif %}
      </div>
    </div>

    <!-- Product Info -->
    <div class="col-md-7">
      <h1 class="mb-3">{{ product.name }}</h1>

      {% if product.is_on_sale %}
        <span class="badge badge-danger badge-lg mb-3">Diskon {{ product.get_discount_percentage }}%</span>
      {% endif %}

      <div class="mb-3">
        <small class="text-muted">Kategori:</small>
        <a href="{% url 'catalog:category_detail' product.category.slug %}" class="badge badge-info">
          {{ product.category.name }}
        </a>
      </div>

      <!-- Price -->
      <div class="mb-4">
        {% if product.is_on_sale %}
          <h4 class="text-muted"><s>Rp {{ product.price|dot_separator }}</s></h4>
          <h2 class="text-danger font-weight-bold">Rp {{ product.get_display_price|dot_separator }}</h2>
        {% else %}
          <h2 class="text-primary font-weight-bold">Rp {{ product.price|dot_separator }}</h2>
        {% endif %}
      </div>

      <!-- Stock -->
      <div class="mb-4">
        <p>
          <i class="fas fa-box text-primary"></i>
          <strong>Stok:</strong>
          {% if product.stock > 0 %}
            <span class="text-success">{{ product.stock }} tersedia</span>
          {% else %}
            <span class="text-danger">Habis</span>
          {% endif %}
        </p>
      </div>

      <!-- Description -->
      <div class="mb-4">
        <h5>Deskripsi Produk</h5>
        <p>{{ product.description|linebreaks }}</p>
      </div>

      <!-- Add to Cart -->
      {% if user.is_authenticated %}
        {% if product.stock > 0 %}
          <form method="post" action="{% url 'core:add_to_cart' product.id %}">
            {% csrf_token %}
            <div class="form-row align-items-center mb-3">
              <div class="col-auto">
                <label for="quantity">Jumlah:</label>
              </div>
              <div class="col-auto">
                <input type="number" name="quantity" id="quantity" class="form-control" value="1" min="1" max="{{ product.stock }}" style="width: 100px;">
              </div>
            </div>
            <button type="submit" class="btn btn-primary btn-lg">
              <i class="fas fa-cart-plus"></i> Tambah ke Keranjang
            </button>
          </form>
        {% else %}
          <button class="btn btn-secondary btn-lg" disabled>
            <i class="fas fa-times"></i> Stok Habis
          </button>
        {% endif %}
      {% else %}
        <a href="{% url 'core:login' %}?next={{ request.path }}" class="btn btn-primary btn-lg">
          <i class="fas fa-sign-in-alt"></i> Login untuk Membeli
        </a>
      {% endif %}
    </div>
  </div>

  <!-- Testimonials Carousel -->
  {% if testimonials %}
  <div class="mt-5 mb-5">
    <h3 class="text-center mb-4">Testimoni Pelanggan</h3>
    <div class="testimonial-carousel-container">
      <div class="testimonial-carousel" id="testimonialCarousel">
        {% for testimonial in testimonials %}
        <div class="testimonial-card" data-index="{{ forloop.counter0 }}">
          <div class="testimonial-content">
            <div class="rating mb-2">
              {% for i in "12345" %}
                {% if forloop.counter <= testimonial.rating %}
                  <i class="fas fa-star text-warning"></i>
                {% else %}
                  <i class="far fa-star text-warning"></i>
                {% endif %}
              {% endfor %}
            </div>
            <p class="testimonial-text">"{{ testimonial.review }}"</p>
            <div class="testimonial-author mt-3">
              <div class="d-flex align-items-center">
                <div class="author-photo mr-3">
                  {% if testimonial.photo %}
                    <img src="{{ testimonial.photo.url }}" alt="{{ testimonial.user.username }}">
                  {% else %}
                    <div class="photo-placeholder">{{ testimonial.user.username|slice:":1"|upper }}</div>
                  {% endif %}
                </div>
                <div>
                  <strong>{{ testimonial.user.get_full_name|default:testimonial.user.username }}</strong>
                  <br>
                  <small class="text-muted">{{ testimonial.created_at|date:"d M Y" }}</small>
                </div>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- Navigation Arrows -->
      <button class="carousel-arrow carousel-arrow-left" onclick="moveCarousel(-1)">
        <i class="fas fa-chevron-left"></i>
      </button>
      <button class="carousel-arrow carousel-arrow-right" onclick="moveCarousel(1)">
        <i class="fas fa-chevron-right"></i>
      </button>
    </div>
  </div>
  {% endif %}

  <!-- Related Products -->
  {% if related_products %}
  <div class="mt-5">
    <h3 class="mb-4">Produk Terkait</h3>
    <div class="row">
      {% for related in related_products %}
      <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
        <div class="card h-100 shadow-sm hover-shadow">
          {% if related.image %}
            <img src="{{ related.image.url }}" class="card-img-top" alt="{{ related.name }}" style="height: 200px; object-fit: cover;">
          {% else %}
            <img src="https://via.placeholder.com/300x200?text={{ related.name }}" class="card-img-top" alt="{{ related.name }}">
          {% endif %}

          <div class="card-body">
            <h5 class="card-title">{{ related.name|truncatewords:5 }}</h5>
            <p class="h6 text-primary">Rp {{ related.get_display_price|floatformat:0 }}</p>
          </div>

          <div class="card-footer bg-white">
            <a href="{% url 'catalog:product_detail' related.slug %}" class="btn btn-sm btn-outline-primary btn-block">
              Lihat Detail
            </a>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}
</div>

<style>
.hover-shadow:hover {
  transform: translateY(-5px);
  transition: all 0.3s ease;
  box-shadow: 0 10px 20px rgba(0,0,0,0.2) !important;
}

/* Testimonial Carousel Styles */
.testimonial-carousel-container {
  position: relative;
  max-width: 1000px;
  margin: 0 auto;
  padding: 20px 60px;
}

.testimonial-carousel {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 20px;
  min-height: 300px;
}

.testimonial-card {
  background: #2d3748;
  border-radius: 15px;
  padding: 30px;
  color: white;
  box-shadow: 0 4px 15px rgba(0,0,0,0.3);
  transition: all 0.5s ease;
  opacity: 1;
}

.testimonial-card.slide-out-left {
  animation: slideOutLeft 0.5s ease forwards;
}

.testimonial-card.slide-out-right {
  animation: slideOutRight 0.5s ease forwards;
}

.testimonial-card.slide-in-left {
  animation: slideInLeft 0.5s ease forwards;
}

.testimonial-card.slide-in-right {
  animation: slideInRight 0.5s ease forwards;
}

@keyframes slideOutLeft {
  from { transform: translateX(0); opacity: 1; }
  to { transform: translateX(-100%); opacity: 0; }
}

@keyframes slideOutRight {
  from { transform: translateX(0); opacity: 1; }
  to { transform: translateX(100%); opacity: 0; }
}

@keyframes slideInLeft {
  from { transform: translateX(-100%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

@keyframes slideInRight {
  from { transform: translateX(100%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

.testimonial-text {
  font-size: 1.1rem;
  line-height: 1.6;
  font-style: italic;
  margin: 20px 0;
}

.author-photo {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  overflow: hidden;
  border: 3px solid #ffc107;
}

.author-photo img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.photo-placeholder {
  width: 100%;
  height: 100%;
  background: #ffc107;
  color: #2d3748;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  font-weight: bold;
}

.carousel-arrow {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  background: #ffc107;
  color: #2d3748;
  border: none;
  width: 45px;
  height: 45px;
  border-radius: 50%;
  cursor: pointer;
  font-size: 18px;
  transition: all 0.3s ease;
  z-index: 10;
  box-shadow: 0 2px 10px rgba(0,0,0,0.3);
}

.carousel-arrow:hover {
  background: #ffdd57;
  transform: translateY(-50%) scale(1.1);
}

.carousel-arrow-left {
  left: 0;
}

.carousel-arrow-right {
  right: 0;
}

.rating i {
  font-size: 1.2rem;
}

@media (max-width: 768px) {
  .testimonial-carousel {
    grid-template-columns: 1fr;
  }

  .testimonial-carousel-container {
    padding: 20px 40px;
  }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let currentIndex = 0;
const testimonialCards = document.querySelectorAll('.testimonial-card');
const totalTestimonials = testimonialCards.length;
const itemsPerPage = 2;
let isAnimating = false;

function updateCarousel() {
  testimonialCards.forEach((card, index) => {
    if (index >= currentIndex && index < currentIndex + itemsPerPage) {
      card.style.display = 'block';
    } else {
      card.style.display = 'none';
    }
  });
}

function moveCarousel(direction) {
  if (isAnimating || totalTestimonials <= itemsPerPage) return;

  isAnimating = true;

  // Get visible cards
  const visibleCards = Array.from(testimonialCards).slice(currentIndex, currentIndex + itemsPerPage);

  // Animate out
  visibleCards.forEach(card => {
    card.classList.add(direction > 0 ? 'slide-out-left' : 'slide-out-right');
  });

  setTimeout(() => {
    // Update index
    currentIndex += direction * itemsPerPage;

    // Loop around
    if (currentIndex >= totalTestimonials) {
      currentIndex = 0;
    } else if (currentIndex < 0) {
      currentIndex = Math.max(0, totalTestimonials - itemsPerPage);
    }

    // Remove animation classes
    testimonialCards.forEach(card => {
      card.classList.remove('slide-out-left', 'slide-out-right', 'slide-in-left', 'slide-in-right');
    });

    // Update display
    updateCarousel();

    // Get new visible cards
    const newVisibleCards = Array.from(testimonialCards).slice(currentIndex, currentIndex + itemsPerPage);

    // Animate in
    newVisibleCards.forEach(card => {
      card.classList.add(direction > 0 ? 'slide-in-right' : 'slide-in-left');
    });

    setTimeout(() => {
      testimonialCards.forEach(card => {
        card.classList.remove('slide-in-left', 'slide-in-right');
      });
      isAnimating = false;
    }, 500);
  }, 500);
}

// Initialize
if (testimonialCards.length > 0) {
  updateCarousel();
}
</script>
{% endblock %}
